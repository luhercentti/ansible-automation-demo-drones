---
- name: Create drone simulator directory
  file:
    path: "{{ drone_simulator_dir }}"
    state: directory
    mode: '0755'

- name: Create drone simulator script
  copy:
    content: |
      #!/usr/bin/env python3
      """
      Simulador de drones para envío de telemetría a ThingsBoard
      """
      import paho.mqtt.client as mqtt
      import json
      import time
      import random
      import sys
      from datetime import datetime
      
      class DroneSimulator:
          def __init__(self, drone_id, thingsboard_host="localhost", thingsboard_port=1883):
              self.drone_id = drone_id
              self.thingsboard_host = thingsboard_host
              self.thingsboard_port = thingsboard_port
              self.access_token = f"DRONE_{drone_id}_TOKEN"
              
              # Posición inicial aleatoria (zona de vigilancia)
              self.latitude = 40.4168 + random.uniform(-0.1, 0.1)
              self.longitude = -3.7038 + random.uniform(-0.1, 0.1)
              self.altitude = random.uniform(50, 150)
              
              # Estado inicial
              self.battery_level = 100.0
              self.speed = random.uniform(10, 30)
              self.mission_id = f"MISSION_{random.randint(1000, 9999)}"
              self.status = "ACTIVE"
              
              self.client = mqtt.Client()
              self.client.username_pw_set(self.access_token)
              
          def connect(self):
              try:
                  self.client.connect(self.thingsboard_host, self.thingsboard_port, 60)
                  self.client.loop_start()
                  print(f"[{self.drone_id}] Connected to ThingsBoard")
                  return True
              except Exception as e:
                  print(f"[{self.drone_id}] Connection failed: {e}")
                  return False
          
          def generate_telemetry(self):
              # Simular movimiento del dron
              self.latitude += random.uniform(-0.001, 0.001)
              self.longitude += random.uniform(-0.001, 0.001)
              self.altitude += random.uniform(-5, 5)
              
              # Simular descarga de batería
              self.battery_level = max(0, self.battery_level - random.uniform(0.1, 0.5))
              
              # Simular variación de velocidad
              self.speed = max(0, min(50, self.speed + random.uniform(-2, 2)))
              
              # Simular temperatura
              temperature = random.uniform(15, 35)
              
              # Cambiar estado si batería baja
              if self.battery_level < 20:
                  self.status = "RETURNING"
              elif self.battery_level < 10:
                  self.status = "CRITICAL"
              
              telemetry = {
                  "timestamp": datetime.utcnow().isoformat() + "Z",
                  "latitude": round(self.latitude, 6),
                  "longitude": round(self.longitude, 6),
                  "altitude": round(self.altitude, 2),
                  "battery_level": round(self.battery_level, 2),
                  "speed": round(self.speed, 2),
                  "temperature": round(temperature, 2),
                  "status": self.status,
                  "mission_id": self.mission_id
              }
              
              return telemetry
          
          def send_telemetry(self):
              telemetry = self.generate_telemetry()
              payload = json.dumps(telemetry)
              
              result = self.client.publish('v1/devices/me/telemetry', payload)
              
              if result.rc == mqtt.MQTT_ERR_SUCCESS:
                  print(f"[{self.drone_id}] Telemetry sent: Battery={telemetry['battery_level']:.1f}%, "
                        f"Position=({telemetry['latitude']:.4f}, {telemetry['longitude']:.4f}), "
                        f"Status={telemetry['status']}")
              else:
                  print(f"[{self.drone_id}] Failed to send telemetry")
          
          def run(self, interval=15):
              if not self.connect():
                  return
              
              print(f"[{self.drone_id}] Starting telemetry transmission every {interval} seconds")
              
              try:
                  while self.battery_level > 0:
                      self.send_telemetry()
                      time.sleep(interval)
                  
                  print(f"[{self.drone_id}] Battery depleted. Simulation ended.")
              except KeyboardInterrupt:
                  print(f"\n[{self.drone_id}] Simulation stopped by user")
              finally:
                  self.client.loop_stop()
                  self.client.disconnect()
      
      def main():
          import argparse
          
          parser = argparse.ArgumentParser(description='Drone Telemetry Simulator')
          parser.add_argument('--drone-id', type=str, required=True, help='Drone ID')
          parser.add_argument('--host', type=str, default='localhost', help='ThingsBoard host')
          parser.add_argument('--port', type=int, default=1883, help='ThingsBoard MQTT port')
          parser.add_argument('--interval', type=int, default=15, help='Telemetry interval in seconds')
          
          args = parser.parse_args()
          
          drone = DroneSimulator(args.drone_id, args.host, args.port)
          drone.run(args.interval)
      
      if __name__ == "__main__":
          main()
    dest: "{{ drone_simulator_dir }}/drone_simulator.py"
    mode: '0755'

- name: Create multi-drone launcher script
  copy:
    content: |
      #!/bin/bash
      # Launcher para múltiples drones
      
      DRONE_COUNT={{ drone_simulator_count }}
      INTERVAL={{ drone_telemetry_interval }}
      TB_HOST="localhost"
      TB_PORT={{ thingsboard_mqtt_port }}
      
      echo "Starting $DRONE_COUNT drone simulators..."
      
      for i in $(seq 1 $DRONE_COUNT); do
          DRONE_ID="DRONE_$(printf "%03d" $i)"
          echo "Launching $DRONE_ID"
          python3 {{ drone_simulator_dir }}/drone_simulator.py \
              --drone-id "$DRONE_ID" \
              --host "$TB_HOST" \
              --port "$TB_PORT" \
              --interval "$INTERVAL" &
          sleep 1
      done
      
      echo "All drones launched. Press Ctrl+C to stop all simulators."
      wait
    dest: "{{ drone_simulator_dir }}/start_drones.sh"
    mode: '0755'

- name: Create systemd service for drone simulator
  copy:
    content: |
      [Unit]
      Description=Drone Telemetry Simulator
      After=docker.service
      Requires=docker.service
      
      [Service]
      Type=forking
      ExecStart={{ drone_simulator_dir }}/start_drones.sh
      ExecStop=/usr/bin/pkill -f drone_simulator.py
      Restart=on-failure
      RestartSec=10
      
      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/drone-simulator.service
    mode: '0644'

- name: Create requirements.txt for drone simulator
  copy:
    content: |
      paho-mqtt==1.6.1
      requests==2.31.0
    dest: "{{ drone_simulator_dir }}/requirements.txt"
    mode: '0644'

- name: Install Python requirements for simulator
  pip:
    requirements: "{{ drone_simulator_dir }}/requirements.txt"
    executable: pip3

- name: Create device provisioning script
  copy:
    content: |
      #!/usr/bin/env python3
      """
      Script para crear dispositivos (drones) en ThingsBoard usando la API REST
      Este script usa las credenciales de tenant que vienen por defecto en ThingsBoard
      """
      import requests
      import json
      import time
      import sys
      
      TB_URL = "http://localhost:{{ thingsboard_http_port }}"
      DRONE_COUNT = {{ drone_simulator_count }}
      SIMULATOR_DIR = "{{ drone_simulator_dir }}"
      
      # Credenciales por defecto de ThingsBoard
      SYSADMIN = {"username": "sysadmin@thingsboard.org", "password": "sysadmin"}
      TENANT = {"username": "tenant@thingsboard.org", "password": "tenant"}
      
      def get_token(username, password):
          """Obtener token de autenticación"""
          try:
              response = requests.post(
                  f"{TB_URL}/api/auth/login",
                  json={"username": username, "password": password},
                  timeout=10
              )
              if response.status_code == 200:
                  return response.json().get("token")
              else:
                  print(f"Login failed for {username}: {response.status_code} - {response.text}")
          except Exception as e:
              print(f"Error connecting to ThingsBoard: {e}")
          return None
      
      def create_device(token, device_name, access_token):
          """Crear dispositivo en ThingsBoard"""
          headers = {
              "Content-Type": "application/json",
              "X-Authorization": f"Bearer {token}"
          }
          
          # Crear dispositivo
          device_data = {
              "name": device_name,
              "type": "Surveillance Drone",
              "label": f"Drone de vigilancia {device_name}"
          }
          
          response = requests.post(
              f"{TB_URL}/api/device",
              headers=headers,
              json=device_data
          )
          
          if response.status_code != 200:
              print(f"✗ Failed to create device {device_name}: {response.text}")
              return None
              
          device_id = response.json()["id"]["id"]
          print(f"✓ Created device: {device_name} (ID: {device_id})")
          
          # Actualizar credenciales con token personalizado
          cred_data = {
              "credentialsType": "ACCESS_TOKEN",
              "credentialsId": access_token
          }
          
          response = requests.post(
              f"{TB_URL}/api/device/{device_id}/credentials",
              headers=headers,
              json=cred_data
          )
          
          if response.status_code == 200:
              print(f"  Access Token: {access_token}")
              return device_id
          else:
              print(f"  Warning: Could not set custom token, using default")
              return device_id
      
      def get_or_create_tenant_user(sysadmin_token):
          """Get tenant user or activate default tenant"""
          headers = {
              "Content-Type": "application/json",
              "X-Authorization": f"Bearer {sysadmin_token}"
          }
          
          # Try to get tenant users
          response = requests.get(f"{TB_URL}/api/users?pageSize=100&page=0", headers=headers)
          if response.status_code == 200:
              users = response.json().get("data", [])
              for user in users:
                  if user.get("email") == "tenant@thingsboard.org":
                      print("✓ Found existing tenant user")
                      # Try to login as tenant
                      tenant_token = get_token(TENANT["username"], TENANT["password"])
                      if tenant_token:
                          return tenant_token
                      # If login fails, try to activate/reset tenant user
                      print("  Tenant user exists but login failed, trying to activate...")
          
          # If we get here, try to activate tenant by resetting password
          print("  Attempting to use default tenant credentials...")
          return get_token(TENANT["username"], TENANT["password"])
      
      def main():
          print("=" * 60)
          print("ThingsBoard Device Provisioning")
          print("=" * 60)
          print("\nWaiting for ThingsBoard to be ready...")
          time.sleep(10)
          
          # First, try to login as tenant directly
          print("\nAttempt 1: Login as tenant...")
          token = get_token(TENANT["username"], TENANT["password"])
          
          if not token:
              print("  Tenant login failed, trying sysadmin approach...")
              # Login as sysadmin
              sysadmin_token = get_token(SYSADMIN["username"], SYSADMIN["password"])
              if not sysadmin_token:
                  print("\n✗ Failed to authenticate with any credentials")
                  print("Please check ThingsBoard is running and accessible at", TB_URL)
                  sys.exit(1)
              
              print(f"✓ Authenticated as sysadmin")
              token = get_or_create_tenant_user(sysadmin_token)
          
          if not token:
              print("\n✗ Could not get tenant token")
              print("Please login to ThingsBoard UI and activate the tenant user")
              print(f"URL: {TB_URL}")
              print("Then create devices manually or run this script again")
              sys.exit(1)
          
          print("✓ Ready to create devices with tenant credentials")
          
          print(f"\nCreating {DRONE_COUNT} drone devices...")
          print("-" * 60)
          
          created_count = 0
          for i in range(1, DRONE_COUNT + 1):
              device_name = f"DRONE_{i:03d}"
              access_token = f"DRONE_{i:03d}_TOKEN"
              
              device_id = create_device(token, device_name, access_token)
              if device_id:
                  created_count += 1
              
              time.sleep(0.5)
          
          print("-" * 60)
          print(f"\n✓ Device provisioning completed!")
          print(f"  Created: {created_count}/{DRONE_COUNT} devices")
          print(f"\nYou can now start the drone simulator:")
          print(f"  {SIMULATOR_DIR}/start_drones.sh")
          print("=" * 60)
      
      if __name__ == "__main__":
          main()
    dest: "{{ drone_simulator_dir }}/provision_devices.py"
    mode: '0755'

- name: Display drone simulator information
  debug:
    msg:
      - "Drone Simulator configured"
      - "Location: {{ drone_simulator_dir }}"
      - "Number of drones: {{ drone_simulator_count }}"
      - "Telemetry interval: {{ drone_telemetry_interval }} seconds"
      - ""
      - "To provision devices in ThingsBoard:"
      - "  python3 {{ drone_simulator_dir }}/provision_devices.py"
      - ""
      - "To start simulation:"
      - "  {{ drone_simulator_dir }}/start_drones.sh"
      - ""
      - "To enable as systemd service:"
      - "  sudo systemctl enable drone-simulator"
      - "  sudo systemctl start drone-simulator"
